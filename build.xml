<?xml version="1.0" encoding="UTF-8"?>

<project name="nation" default="full-suite" basedir=".">

    <!-- GLOBAL VARIABLES -->
    <property name="source" value="app" />
    <!-- END -->

    <!-- AVAILABLE COMMANDS -->
    <target name="full-suite" depends="date, prepare, lint, composer" />
    <!-- END -->

    <!-- DATE -->
    <target name="date">
        <echo message="Printing system date ..."/>
        <exec executable="date" />
    </target>
    <!-- END -->

    <!-- CLEAN -->
    <target name="clean"
            unless="clean.done"
            description="Cleanup build artifacts">
        <delete dir="${basedir}/build/api"/>
        <delete dir="${basedir}/build/coverage"/>
        <delete dir="${basedir}/build/logs"/>
        <delete dir="${basedir}/build/pdepend"/>
        <delete dir="${basedir}/build/phpdox"/>
        <property name="clean.done" value="true"/>
    </target>
    <!-- END -->

    <!-- PREPARE -->
    <target name="prepare"
            unless="prepare.done"
            depends="clean"
            description="Prepare for build">
        <echo message="Create build directories ..." />
        <mkdir dir="${basedir}/build/api"/>
        <mkdir dir="${basedir}/build/coverage"/>
        <mkdir dir="${basedir}/build/logs"/>
        <mkdir dir="${basedir}/build/pdepend"/>
        <mkdir dir="${basedir}/build/phpdox"/>
        <property name="prepare.done" value="true"/>
    </target>
    <!-- END -->

    <!-- LINT -->
    <target name="lint"
            unless="lint.done"
            description="Perform syntax check of sourcecode files">
        <echo message="Checking php syntax ..." />
        <apply executable="php" taskname="lint" failonerror="true">
            <arg value="-l" />

            <fileset dir="${basedir}/src">
                <include name="**/*.php" />
                <modified />
            </fileset>

            <fileset dir="${basedir}/tests">
                <include name="**/*.php" />
                <modified />
            </fileset>
        </apply>
        <property name="lint.done" value="true"/>
    </target>
    <!-- END -->

    <!-- PHPLOC -->
    <target name="phploc-ci"
            unless="phploc.done"
            depends="prepare"
            description="Measure project size using PHPLOC and log result in CSV and XML format. Intended for usage within
             a continuous integration environment.">
        <echo message="Measure project size ..." />
        <exec executable="${phploc}" taskname="phploc">
            <arg value="--count-tests" />
            <arg value="--log-csv" />
            <arg path="${basedir}/build/logs/phploc.csv" />
            <arg value="--log-xml" />
            <arg path="${basedir}/build/logs/phploc.xml" />
            <arg path="${basedir}/src" />
            <arg path="${basedir}/tests" />
        </exec>
        <property name="phploc.done" value="true"/>
    </target>
    <!-- END -->

    <!-- COMPOSER -->
    <target name="composer" unless="composer.done" description="Install Vendor code ...">
        <echo message="Running composer self-update ..." />
        <exec executable="/var/lib/jenkins/composer">
            <arg value="self-update" />
        </exec>
        <echo message="Running composer install ..." />
        <exec executable="/var/lib/jenkins/composer" failonerror="true">
            <arg value="install" />
            <arg value="--no-interaction" />
        </exec>
        <property name="composer.done" value="true"/>
    </target>
    <!-- END -->



</project>